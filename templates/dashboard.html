{% extends "layout.html" %}

{% block content %}
<div class="container py-4">
    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="card-title mb-0">Trainer Dashboard</h2>
                        <a href="{{ url_for('create_plan') }}" class="btn btn-primary">
                            <i data-feather="user-plus" class="me-2"></i>Add New Client
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="feature-icon mb-3">
                        <i data-feather="users" class="text-primary"></i>
                    </div>
                    <h3 class="fs-2 mb-2">{{ stats.total_clients }}</h3>
                    <p class="mb-0">Active Clients</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="feature-icon mb-3">
                        <i data-feather="activity" class="text-primary"></i>
                    </div>
                    <h3 class="fs-2 mb-2">{{ stats.weekly_workouts }}</h3>
                    <p class="mb-0">Workouts This Week</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="feature-icon mb-3">
                        <i data-feather="trending-up" class="text-primary"></i>
                    </div>
                    <h3 class="fs-2 mb-2">{{ stats.improving_clients }}%</h3>
                    <p class="mb-0">Clients Improving</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="feature-icon mb-3">
                        <i data-feather="check-circle" class="text-primary"></i>
                    </div>
                    <h3 class="fs-2 mb-2">{{ stats.completion_rate }}%</h3>
                    <p class="mb-0">Completion Rate</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity and Client List -->
    <div class="row">
        <!-- Client List -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Active Clients</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Goal</th>
                                    <th>Progress</th>
                                    <th>Last Activity</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for client in clients %}
                                <tr>
                                    <td>{{ client.name }}</td>
                                    <td>{{ client.goal|replace('_', ' ')|title }}</td>
                                    <td>
                                        {% if client.trend == 'improving' %}
                                            <span class="badge bg-success">Improving</span>
                                        {% elif client.trend == 'declining' %}
                                            <span class="badge bg-warning">Needs Focus</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Stable</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ client.last_activity|default('No activity', true) }}</td>
                                    <td>
                                        <div class="btn-group">
                                            <a href="{{ url_for('view_progress', client_id=client.id) }}" 
                                               class="btn btn-sm btn-primary">
                                                <i data-feather="activity" class="feather-small"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-primary" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#editClientModal"
                                                    data-client-id="{{ client.id }}">
                                                <i data-feather="edit-2" class="feather-small"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Feed -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Activity Feed</h3>
                </div>
                <div class="card-body">
                    <div class="activity-feed">
                        {% for activity in activity_feed %}
                        <div class="activity-item mb-3 p-3 border-start border-4 {% if activity.priority == 'high' %}border-warning{% elif activity.priority == 'low' %}border-info{% else %}border-primary{% endif %} rounded-3">
                            <div class="d-flex align-items-center mb-2">
                                <div class="activity-icon me-3">
                                    <i data-feather="{{ activity.icon }}" class="{% if activity.priority == 'high' %}text-warning{% elif activity.priority == 'low' %}text-info{% else %}text-primary{% endif %}"></i>
                                </div>
                                <div>
                                    <strong class="d-block">{{ activity.client_name }}</strong>
                                    <small class="text-muted">{{ activity.timestamp }}</small>
                                </div>
                                {% if activity.is_milestone %}
                                <span class="badge bg-success ms-auto">Milestone</span>
                                {% endif %}
                            </div>
                            <p class="mb-0">{{ activity.description }}</p>
                            {% if activity.extra_data %}
                            <div class="activity-metadata mt-2">
                                {% for key, value in activity.extra_data.items() %}
                                <small class="d-block text-muted">{{ key|title }}: {{ value }}</small>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Client Modal -->
<div class="modal fade" id="editClientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Client</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editClientForm">
                    <input type="hidden" id="clientId" name="clientId">
                    <div class="mb-3">
                        <label for="clientName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="clientName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="clientGoal" class="form-label">Goal</label>
                        <select class="form-select" id="clientGoal" name="goal" required>
                            <option value="weight_loss">Weight Loss</option>
                            <option value="muscle_gain">Muscle Gain</option>
                            <option value="endurance">Endurance</option>
                            <option value="strength">Strength</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="clientFitnessLevel" class="form-label">Fitness Level</label>
                        <select class="form-select" id="clientFitnessLevel" name="fitness_level" required>
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveClientButton">Save Changes</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const editClientModal = document.getElementById('editClientModal');
    const saveClientButton = document.getElementById('saveClientButton');

    // Handle modal opening
    editClientModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const clientId = button.getAttribute('data-client-id');

        // Clear previous alerts
        const alerts = editClientModal.querySelectorAll('.alert');
        alerts.forEach(alert => alert.remove());

        // Fetch and populate client data
        fetch(`/api/client/${clientId}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('clientId').value = data.id;
                document.getElementById('clientName').value = data.name;
                document.getElementById('clientGoal').value = data.goal;
                document.getElementById('clientFitnessLevel').value = data.fitness_level;
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error loading client data', 'danger');
            });
    });

    // Handle save button click
    saveClientButton.addEventListener('click', function() {
        const clientId = document.getElementById('clientId').value;
        const data = {
            name: document.getElementById('clientName').value,
            goal: document.getElementById('clientGoal').value,
            fitness_level: document.getElementById('clientFitnessLevel').value
        };

        // Disable button and show loading state
        saveClientButton.disabled = true;
        saveClientButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';

        // Send update request
        fetch(`/api/client/${clientId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showAlert('Changes saved successfully!', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                throw new Error(result.error || 'Failed to save changes');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert(error.message || 'Error saving changes', 'danger');
            // Reset button state
            saveClientButton.disabled = false;
            saveClientButton.innerHTML = 'Save Changes';
        });
    });

    // Helper function to show alerts
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        editClientModal.querySelector('.modal-body').insertBefore(alertDiv, editClientModal.querySelector('form'));
    }
});
</script>
{% endblock %}