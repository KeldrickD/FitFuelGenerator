{% extends "layout.html" %}

{% block content %}
<div class="container py-4">
    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="card-title mb-0">Trainer Dashboard</h2>
                        <a href="{{ url_for('create_plan') }}" class="btn btn-primary">
                            <i data-feather="user-plus" class="me-2"></i>Add New Client
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row g-4 mb-4">
        {% include '_stats_cards.html' %}
    </div>

    <!-- Progress Visualizations -->
    <div class="row g-4 mb-4">
        <!-- Weekly Workout Completion -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h3 class="card-title">Weekly Workout Completion</h3>
                </div>
                <div class="card-body">
                    <div style="height: 300px; width: 100%; position: relative;">
                        <canvas id="weeklyWorkoutChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Client Progress Distribution -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h3 class="card-title">Client Progress Distribution</h3>
                </div>
                <div class="card-body">
                    <div style="height: 300px; width: 100%; position: relative;">
                        <canvas id="clientProgressChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Exercise Type Completion -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h3 class="card-title">Exercise Type Distribution</h3>
                </div>
                <div class="card-body">
                    <div style="height: 300px; width: 100%; position: relative;">
                        <canvas id="exerciseTypeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Goal Progress Tracking -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h3 class="card-title">Client Goal Progress</h3>
                </div>
                <div class="card-body">
                    <div style="height: 300px; width: 100%; position: relative;">
                        <canvas id="goalProgressChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Client List -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Active Clients</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Goal</th>
                                    <th>Progress</th>
                                    <th>Last Activity</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for client in clients %}
                                <tr>
                                    <td>{{ client.name }}</td>
                                    <td>{{ client.goal|replace('_', ' ')|title }}</td>
                                    <td>
                                        {% if client.trend == 'improving' %}
                                            <span class="badge bg-success">Improving</span>
                                        {% elif client.trend == 'declining' %}
                                            <span class="badge bg-warning">Needs Focus</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Stable</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ client.last_activity|default('No activity', true) }}</td>
                                    <td>
                                        <div class="btn-group">
                                            <a href="{{ url_for('view_progress', client_id=client.id) }}" 
                                               class="btn btn-sm btn-primary">
                                                <i data-feather="activity" class="feather-small"></i>
                                            </a>
                                            <a href="{{ url_for('goal_wizard', client_id=client.id) }}"
                                               class="btn btn-sm btn-primary">
                                                <i data-feather="target" class="feather-small"></i>
                                            </a>
                                            <a href="{{ url_for('view_achievements', client_id=client.id) }}"
                                               class="btn btn-sm btn-primary">
                                                <i data-feather="award" class="feather-small"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Feed -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Activity Feed</h3>
                </div>
                <div class="card-body">
                    <div class="activity-feed">
                        {% for activity in activity_feed %}
                        <div class="activity-item mb-3 p-3 border-start border-4 {% if activity.priority == 'high' %}border-warning{% elif activity.priority == 'low' %}border-info{% else %}border-primary{% endif %} rounded-3">
                            <div class="d-flex align-items-center mb-2">
                                <div class="activity-icon me-3">
                                    <i data-feather="{{ activity.icon }}" class="{% if activity.priority == 'high' %}text-warning{% elif activity.priority == 'low' %}text-info{% else %}text-primary{% endif %}"></i>
                                </div>
                                <div>
                                    <strong class="d-block">{{ activity.client_name }}</strong>
                                    <small class="text-muted">{{ activity.timestamp }}</small>
                                </div>
                                {% if activity.is_milestone %}
                                <span class="badge bg-success ms-auto">Milestone</span>
                                {% endif %}
                            </div>
                            <p class="mb-0">{{ activity.description }}</p>
                            {% if activity.extra_data %}
                            <div class="activity-metadata mt-2">
                                {% for key, value in activity.extra_data.items() %}
                                <small class="d-block text-muted">{{ key|title }}: {{ value }}</small>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Load Chart.js from CDN before your script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Feather icons
    if (typeof feather !== 'undefined') {
        feather.replace();
    }

    console.log('Initializing charts...'); // Debug log
    console.log('Progress data:', {{ progress_data|tojson }}); // Debug log

    // Chart.js Global Configuration
    Chart.defaults.color = '#fff';
    Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
    Chart.defaults.plugins.legend.labels.color = '#fff';
    Chart.defaults.scale.grid.color = 'rgba(255, 255, 255, 0.1)';
    Chart.defaults.scale.ticks.color = '#fff';

    try {
        // Weekly Workout Completion Chart
        const weeklyWorkoutCtx = document.getElementById('weeklyWorkoutChart');
        console.log('Weekly workout data:', {{ progress_data.weekly_workouts|tojson }}); // Debug log

        if (weeklyWorkoutCtx) {
            new Chart(weeklyWorkoutCtx, {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Completed Workouts',
                        data: {{ progress_data.weekly_workouts|tojson }},
                        backgroundColor: 'rgba(var(--bs-primary-rgb), 0.5)',
                        borderColor: 'var(--bs-primary)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        } else {
            console.error('Weekly workout chart canvas not found');
        }

        // Client Progress Distribution Chart
        const clientProgressCtx = document.getElementById('clientProgressChart');
        if (clientProgressCtx) {
            new Chart(clientProgressCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Improving', 'Maintaining', 'Needs Focus'],
                    datasets: [{
                        data: [
                            {{ progress_data.client_improvements.improving }},
                            {{ progress_data.client_improvements.maintaining }},
                            {{ progress_data.client_improvements.declining }}
                        ],
                        backgroundColor: [
                            'rgba(var(--bs-success-rgb), 0.5)',
                            'rgba(var(--bs-info-rgb), 0.5)',
                            'rgba(var(--bs-warning-rgb), 0.5)'
                        ],
                        borderColor: [
                            'var(--bs-success)',
                            'var(--bs-info)',
                            'var(--bs-warning)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        } else {
            console.error('Client progress chart canvas not found');
        }

        // Exercise Type Chart
        const exerciseTypeCtx = document.getElementById('exerciseTypeChart');
        if (exerciseTypeCtx) {
            new Chart(exerciseTypeCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys({{ progress_data.completion_by_type|tojson }}),
                    datasets: [{
                        data: Object.values({{ progress_data.completion_by_type|tojson }}),
                        backgroundColor: [
                            'rgba(var(--bs-primary-rgb), 0.5)',
                            'rgba(var(--bs-success-rgb), 0.5)',
                            'rgba(var(--bs-info-rgb), 0.5)'
                        ],
                        borderColor: [
                            'var(--bs-primary)',
                            'var(--bs-success)',
                            'var(--bs-info)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        } else {
            console.error('Exercise type chart canvas not found');
        }

        // Goal Progress Chart
        const goalProgressCtx = document.getElementById('goalProgressChart');
        const goalProgressData = {{ progress_data.goal_progress|tojson }};
        if (goalProgressCtx) {
            new Chart(goalProgressCtx, {
                type: 'bar',
                data: {
                    labels: goalProgressData.map(item => item.client_name),
                    datasets: [{
                        label: 'Goal Progress (%)',
                        data: goalProgressData.map(item => item.progress),
                        backgroundColor: 'rgba(var(--bs-info-rgb), 0.5)',
                        borderColor: 'var(--bs-info)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        } else {
            console.error('Goal progress chart canvas not found');
        }
    } catch (error) {
        console.error('Error initializing charts:', error);
    }
});
</script>
{% endblock %}